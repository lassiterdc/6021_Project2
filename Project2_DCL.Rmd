---
title: "Project 2"
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: true
    theme: united
  pdf_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.fullwidth=TRUE)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(forecast)
library(imputeTS)
library(ggplot2)
library(ggpubr)
library(ggbiplot)
# library(ggfortify)
library(ggResidpanel)
library(MASS)
library(forecast)
library(tidyverse)
library(lubridate)
library(mtsdi)
library("car")
library(tseries)
library(MTS)
library(here)
library(tsibble)
library(feasts)
library(fable)
library(dplyr)
library(timeDate)
sourcedir <- "C:/Users/Daniel/Dropbox/Self organization/Education/UVA/Graduate School/Coursework/Fall_2020/SYS 6021 Linear Statistical Models/Source"
datadir <- "C:/Users/Daniel/Dropbox/Self organization/Education/UVA/Graduate School/Coursework/Fall_2020/SYS 6021 Linear Statistical Models/6021_Project2/"

setwd(sourcedir)

source("SPM_Panel.R")
source("PCAplots.R")
source("FactorPlots.R")
source("pc.glm.R")
source("ROC.R")
source("TestSet.R")


```


```{r, echo = FALSE}
# Load data and impute missing values
setwd(datadir)

airquality = read.csv('AirQualityUCI.csv')

# replace -200 with NA
airquality[airquality == -200] <- NA

# convert integer type to numeric
intcols = c(4,5,7,8,9,10,11,12)
for(i in 1:length(intcols)){
  airquality[,intcols[i]] <- as.numeric(airquality[,intcols[i]])
}

setwd(sourcedir)

# create new data frame with just NO2 and impute missing values
AQdata = airquality["NO2.GT."]
AQdata = na_interpolation(AQdata)

# aggregate to daily maxima for model building
dailyAQ <- aggregate(AQdata, by=list(as.Date(airquality[,1],"%m/%d/%Y")), 
                     FUN=max) %>% as_tsibble(index = Group.1) %>%
          dplyr::rename("Date" = "Group.1") %>% dplyr::rename("NO2" = "NO2.GT.")

# create time series of NO2
NO2.ts <- ts(dailyAQ[,2])
```

# Exploratory Data Analysis
## Inspecting for trends and seasonality
```{r}
# For quickly formatting plots
my_theme <- theme(plot.title = element_text(hjust = 0.5, size = 16), 
        axis.title = element_text(size = 12), 
        axis.text = element_text(size = 12),
        plot.caption = element_text(size = 12, hjust = 0))
```

```{r}
dailyAQ %>% autoplot(NO2) + ylab("NO2 (mg/m^3)") + xlab("Date") + 
  ggtitle("Nitrogen Concentration") + my_theme
```

The time series plot indicates potential seasonal components and a potential trend component.

```{r}
dailyAQ %>% gg_season(NO2, period = "week") + ylab("NO2 (mg/m^3)") + xlab("") + 
    ggtitle("Nitrogen Concentration") + my_theme
```

This plot indicates an increasing trend over time.


```{r}
dailyAQ %>% model(STL(NO2 ~ trend(window=21) + season(window = "periodic"), robust = TRUE)) %>%
  components() %>%autoplot() + my_theme + ylab("NO2 (mg/m^3)")
```

This seasonal decomposition chart shows a possibly increasing trend and a weekly seasonal component.



```{r}
pg.NO2 <- spec.pgram(NO2.ts,spans=9,demean=T,log='no')

spec.NO2 <- data.frame(freq=pg.NO2$freq, spec=pg.NO2$spec)

spec.NO2 <- data.frame(freq=pg.NO2$freq, spec=pg.NO2$spec) %>% mutate(period = 1/freq) %>% arrange(desc(spec))
spec.NO2[18, ]
```
* There is a peak at around 1.5 which corresponds to a seasonality component
  with a period of 1 week.
  
## Hypotheses from exploratory data analysis:

* There is an increasing trend in NO2 emissions. This could be due to increasing cars on the road over time.
* There is a weekly seasonal component. This could be a function of the number of cars on the road,
  and perhaps traffic is higher on the weekends.


# Building Univariate Time Series Models
```{r}
# Creating potential predictors
dailyAQ <- dailyAQ %>% mutate(step = 1:length(Date)) %>%
      mutate(day = as.factor(as.character(lubridate::wday(Date, label  = TRUE)))) %>%
      mutate(weekend = isWeekend(Date))

# Create train and test sets
dailyAQ_train <- dailyAQ %>% head(n = length(Date) - 8)
dailyAQ_test <- dailyAQ %>% tail(n = 7)
```


## Modeling trend and season
```{r}
# Create potential trend/season models
models <- dailyAQ_train %>%
  model(trend = TSLM(NO2 ~ trend()),
        trend_season_7 = TSLM(NO2 ~ trend() + sin(2*pi*step/7) + cos(2*pi*step/7)), 
        trend_season_mnthly = TSLM(NO2 ~ trend() + sin(2*pi*step/(365.25/12)) + cos(2*pi*step/(365.25/12))), 
        trend_season_w_wkday_dummy = TSLM(NO2 ~ trend() + day),         
        trend_season_w_wknd_dummy = TSLM(NO2 ~ trend() + weekend))
```


```{r}
# Inspect the trend only model
models %>% dplyr::select(trend) %>% report()
```
The coefficient on trend is significant, and plotting the modeled trend line 
against the original data below verifies this.

```{r}
models %>% dplyr::select(trend) %>% fitted() %>%
  autoplot(color = 'red') + autolayer(dailyAQ_train) +
        ggtitle("Trend Model") + ylab("NO2 mg/m^3") + xlab("") + my_theme
```


The model summary and graph of the auto-selected trend and season model 
shows that the trend is still significant. The 3 week and 4 week coefficients


```{r}
models %>% dplyr::select(trend_season_w_wkday_dummy) %>% report()

models %>% dplyr::select(trend_season_w_wkday_dummy) %>% fitted() %>%
  autoplot(color = 'red') + autolayer(dailyAQ_train) +
        ggtitle("Trend-Season Model with Day-of-the-week Dummy Variables") + ylab("NO2 mg/m^3") + xlab("") + my_theme
```


This model used a dummy variable for each day of the week. Friday is the base case.
Only Saturday and Sunday were significantly different from the base case. NO2
concentrations on these days are lower. Perhaps traffic is heavier during the
weekdays because of commuters. It is also notable that the trend term is still
significant once the seasonality component has been accounted for.

Next we tried modeling the seasonal component with a single dummy variable 
indicating whether the date was on a weekday or weekend.

```{r}
models %>% dplyr::select(trend_season_w_wknd_dummy) %>% report()

models %>% dplyr::select(trend_season_w_wknd_dummy) %>% fitted() %>%
  autoplot(color = 'red') + autolayer(dailyAQ_train) +
        ggtitle("Trend-Season Model with Dummy Variables") + ylab("NO2 mg/m^3") + xlab("") + my_theme
```

All coefficients are significant indicating this is a strong candidate model.


The models reported in the summary and plot below had trigonometric functions 
to model 7 day and 30 day seasonal components.
```{r}
models %>% dplyr::select(trend_season_7, trend_season_mnthly) %>% coef()

models %>% 
  dplyr::select(trend_season_7, trend_season_mnthly) %>% 
  fitted() %>% autoplot() +
  autolayer(dailyAQ_train) + 
  ggtitle("Trend-Season Model with Trigonometric Functions") + 
  ylab("NO2 mg/m^3") + xlab("") + my_theme
```

The 7-day period functions produce more significant coefficients indicating that 
a weekly trend is more significant than an approximately monthly trend.

To decide which is the best approach, we compared performance metrics across
the candidate models with a trend and seasonal component.

```{r}
models %>% 
  dplyr::select(trend_season_7, trend_season_mnthly, 
         trend_season_w_wkday_dummy, trend_season_w_wknd_dummy) %>% 
  report() %>% dplyr::select(.model, adj_r_squared, AIC, BIC, df.residual)
```
The day-of-the-week and weekend dummy variable models had the best adjusted R^2.
The weekend dummy variable model had the best AIC and BIC. The weekday dummy 
variable model had the lowest residuals. 

We decided to stick choose the first, third, and fourth model for the remainder
of the analysis.


## Modeling the residuals of best trend/season models
```{r}
# Extract model residuals
data_resids <- models %>%
  dplyr::select(trend_season_7, trend_season_w_wkday_dummy, trend_season_w_wknd_dummy) %>% 
  residuals()

# Plot the residuals
data_resids %>% autoplot(.resid) + ggtitle("Trend/Season Model Residuals") + 
  xlab("") +  my_theme
```

There is clearly some autocorrelation in the residuals.

```{r, fig.height=11, fig.width=8, fig.align='center'}
plt_resid_ACF <- data_resids %>%
  # dplyr::filter(.model == 'trend_season_w_wknd_dummy') %>%
  ACF(.resid) %>% autoplot() + ggtitle("NO2 Residuals ACF plot") + my_theme

plt_resid_PACF <- data_resids %>%
  # dplyr::filter(.model == 'trend_season_w_wknd_dummy') %>% 
  PACF(.resid) %>% autoplot() + ggtitle("NO2 Residuals PACF plot") + my_theme

ggarrange(plt_resid_ACF,plt_resid_PACF,nrow=2,ncol=1)
```


All three models exhibit similar behavior in the ACF and PACF. 
There is sinusoidal decay in the ACF of the residuals. The PACF could be
interpreted as  cutting off after lag 2 or as exhibiting sinusoidal behavior. 
This indicates that the residuals could be modeled as either AR(2) or as an
ARMA process.



```{r}
# Model the residuals
models_residuals <- data_resids %>%
  rename("model" = ".model", "resid" = ".resid") %>%
  model(auto.arima = ARIMA(resid ~ PDQ(0,0,0)), 
        ar2 = ARIMA(resid ~ pdq(2, 0, 0) + PDQ(0,0,0)))
# Show the pdq values from the auto.arima models
models_residuals %>% tidy() %>% filter(.model == 'auto.arima')
```

The auto-selection process yielded ARMA(2, 1) models for each set of residuals.

```{r}
# Compare AIC and BIC across the models
models_residuals %>% report() %>%
  dplyr::select(model, .model, AIC, BIC)

```

For each set of residuals, the ARMA(2, 1) model had the lowest AIC but the AR(2)
model had the lowest BIC probably because it has fewer terms.

```{r}
# Plot residuals vs. fitted
models_residuals_fitted <-
  models_residuals %>% fitted() %>% as_tibble() %>% dplyr::select(Date, '.fitted')

models_residuals_resid <- 
  models_residuals %>% residuals() %>% as_tibble()

model_residuals_fittedAndResiduals <- 
  inner_join(models_residuals_resid, models_residuals_fitted, by = "Date")

ggplot(model_residuals_fittedAndResiduals, aes(.fitted, .resid)) +
    geom_point() + facet_grid(rows = vars(model), cols = vars(.model))
```

There is no clear trend in the residuals for any residual data/model combination.

```{r}
# Plot QQ plots
ggplot(model_residuals_fittedAndResiduals, aes(sample = .resid)) +
    stat_qq() + stat_qq_line(color = "red") + 
    facet_grid(rows = vars(model), cols = vars(.model))
```

The residuals for each model all appear to exhibit similar patterns and are 
approximately gaussian with some fat-tail behavior.


# Forecasting
## Residuals forecasting
```{r}
resid_summary <- models_residuals %>% augment()

resid_7day_forecast <- models_residuals %>%
  forecast(h = "1 week")

plt_resid_forecast <- resid_7day_forecast %>% feasts::autoplot(alpha = 0.8) +
  geom_line(data = resid_summary, aes(x = Date, y = resid)) + 
  ggtitle("Forecast of residuals") + my_theme

plt_resid_forecast

resid_7day_forecast <- resid_7day_forecast %>% hilo(level = 95)

```

The forecast of residuals look reasonable and very similar for each model but the confidence interval on the auto.arima model which is ARMA(2, 1) appears tighter.



## Season/trend forecasting
```{r}
main_summary <- models %>% select(trend_season_w_wknd_dummy, trend_season_w_wkday_dummy, trend_season_7) %>% augment()

main_7day_forecast <- models %>% 
  select(trend_season_w_wknd_dummy, trend_season_w_wkday_dummy, trend_season_7) %>%
  forecast(new_data = dailyAQ_test)
```

## Combining Season/trend and residuals forecasts and computing MSE
```{r}
full_model_summary <- resid_summary %>% 
  left_join(main_summary,
            by = c("Date" = "Date", "model" = ".model"),
            suffix = c(".resid", ".full"))

full_forecast <- left_join(resid_7day_forecast, main_7day_forecast,
                           by = c("model" = ".model", "Date" = "Date"),
                           suffix = c(".resid", ".full")) %>%
                mutate(pt_pred = .mean.resid + .mean.full) 

test_data <- dailyAQ_test %>%
  dplyr::select(Date, "NO2") %>%
  rename("NO2_Actual" = "NO2")

full_forecast <- full_forecast %>% inner_join(test_data, by = ("Date" = "Date"))

forecast_MSE <- full_forecast %>% as_tibble() %>% group_by(model, .model) %>%
  mutate(sqrd_error = (pt_pred - NO2_Actual)^2) %>% summarize(MSE = mean(sqrd_error))

```


## Ploting forecasts and MSE
```{r, fig.height=5.5, fig.width=10, fig.align='center'}
full_forecast <- full_forecast %>% unpack_hilo(cols = "95%") %>%
  mutate(`95%_upper` = .mean.full + `95%_upper`) %>%
  mutate(`95%_lower` = .mean.full + `95%_lower`) %>% 
  mutate(model_ID = paste(model, .model, sep = "_"))
  
plot_forecasts <- ggplot(data = full_forecast, aes(group = model_ID, color = model_ID)) + 
  geom_line(aes(x=Date,y=NO2_Actual), color = "black") + 
  geom_line(aes(x=Date,y=pt_pred)) + 
  geom_line(aes(x=Date,y=`95%_lower`),linetype="dashed") + 
  geom_line(aes(x=Date,y=`95%_upper`),linetype="dashed") +
  xlab("") + ylab("NO2 mg/m^3") + 
  ggtitle("NO2 Season/Trend Model + ARMA of Residuals with 95% CIs") + my_theme

plot_forecasts

forecast_MSE
```

The plot comparing test set prediction performance across each trend/season and
residual model combination fails to clearly show which model is best. However,
the mean squared error indicates that the auto.arima models - ARMA(2,1) - are 
best across the board for modeling residuals. The best trend/season model appears
to the one with weekend dummy variables.








